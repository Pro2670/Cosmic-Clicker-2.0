<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Clickers - Minigame Update</title>
    <style>
        /* --- CSS VARIABLES & BASE --- */
        :root {
            --primary: #a855f7; /* Violet */
            --secondary: #3b82f6; /* Blue */
            --bg-color: #0f172a; /* Slate 900 */
            --panel-bg: rgba(30, 41, 59, 0.95); /* Slate 800 transparent */
            --text-color: #f8fafc; /* White */
            --green: #22c55e; /* Green 500 */
            --grey: #94a3b8; /* Slate 400 */
            --danger: #ef4444; /* Red 500 */
            --cooldown-color: #f97316; /* Orange */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            transition: background 0.5s ease;
            user-select: none;
            background: linear-gradient(135deg, #000000, #434343);
            position: relative;
        }

        /* --- THEMES (Theme styles removed for brevity, assuming they are in the full code) --- */
        /* Placeholder for Themes (These would be defined in a real CSS file) */
        .theme-default { 
            background: linear-gradient(135deg, #0f172a, #434343);
            --primary: #a855f7;
        }
        .event-candy-sage {
            background: linear-gradient(135deg, #be185d, #f97316);
            --primary: #fecaca;
        }
        .event-grassland-joy {
            background: linear-gradient(135deg, #166534, #86efac);
            --primary: #34d399;
        }

        /* --- MAIN MENU --- */
        #main-menu-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        #main-menu-overlay h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
            animation: floatText 3s ease-in-out infinite;
        }

        @keyframes floatText {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .menu-play-btn {
            font-size: 1.5rem;
            padding: 15px 50px;
            background: var(--green);
            border: none;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px var(--green);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 30px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .menu-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px var(--green);
        }

        .menu-stats {
            margin-top: 20px;
            color: var(--grey);
            font-size: 0.9rem;
        }

        /* --- TOP LEFT MENU BUTTON --- */
        #top-menu-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 20;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* --- HEADER & CURRENCY --- */
        header {
            width: 100%;
            padding: 15px;
            padding-left: 100px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        .currency-container { 
            display: flex; 
            gap: 15px; 
            font-weight: bold; 
            font-size: 0.9rem; 
        }
        .currency {
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
        }

        /* --- EVENT HUD (FIXED) --- */
        #event-hud {
            position: absolute;
            top: 60px; /* Below the main header */
            left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 15px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--primary);
            box-shadow: 0 0 15px var(--primary);
            opacity: 0;
            transition: opacity 0.3s;
        }
        #event-hud.active { opacity: 1; }
        #event-hud strong { 
            font-size: 1rem; 
            color: var(--text-color); 
            text-shadow: 0 0 5px var(--primary);
        }
        .hud-circle {
            min-width: 45px;
            height: 25px;
            line-height: 25px;
            text-align: center;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.8rem;
            color: #0f172a;
        }
        .hud-mult { background: var(--green); }
        .hud-time { background: var(--cooldown-color); }

        /* --- MAIN CLICK AREA --- */
        #game-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
            position: relative;
        }

        #clicker-btn {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--primary), #000);
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 50px var(--primary);
            cursor: pointer;
            position: relative;
            touch-action: manipulation;
            -webkit-user-select: none;
            transition: transform 0.1s;
        }
        
        /* --- SKILLS/FRENZY BUTTON --- */
        #active-skills {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .skill-btn {
            padding: 8px 15px;
            background: var(--primary); 
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s, background 0.2s;
            font-size: 0.9rem;
        }
        
        .skill-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- TABS & PANELS --- */
        .tabs {
            display: flex;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            flex-grow: 1;
            padding: 12px 0;
            background: transparent;
            border: none;
            color: var(--grey);
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s, background 0.2s;
            font-size: 0.85rem;
        }

        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active { color: var(--primary); box-shadow: inset 0 -3px 0 0 var(--primary); }

        .panel-container {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            background: var(--panel-bg);
            padding: 10px;
        }

        .panel { display: none; padding: 10px; }
        .panel.active { display: block; }

        /* --- SHOP ITEMS --- */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: background 0.2s;
        }

        .shop-item strong { color: var(--secondary); font-size: 1rem; }
        .shop-item small { color: var(--grey); font-size: 0.75rem; }

        .btn-buy {
            padding: 8px 15px;
            background: var(--green);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; background: var(--cooldown-color); }
        
        /* --- MINI-GAMES --- */
        .mini-game-container {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Slots */
        #slots {
            display: flex; justify-content: center; gap: 5px;
            margin-bottom: 15px; font-size: 2.5rem; font-weight: bold;
            height: 60px; overflow: hidden;
        }
        .slot-reel {
            width: 60px; background: #0f172a;
            border: 2px solid var(--secondary);
            border-radius: 5px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* Memory */
        #memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin: 10px auto;
            max-width: 300px;
        }
        .memory-card {
            width: 100%;
            padding-top: 100%; /* Makes cards square */
            position: relative;
            background: #475569;
            border-radius: 5px;
            color: white;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        .memory-card.flipped { background: var(--primary); }
        .memory-card.matched { background: var(--green); color: #000; }
        .memory-card > * { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* Space Dash */
        #space-dash-area {
            width: 90%;
            max-width: 400px;
            height: 150px;
            background: #1e3a8a; /* Deep Space Blue */
            border: 3px solid var(--primary);
            border-radius: 8px;
            margin: 10px auto;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }

        #dash-player {
            position: absolute;
            bottom: 10px;
            left: 20px;
            width: 25px;
            height: 25px;
            background: var(--green);
            border: 2px solid white;
            border-radius: 4px;
            z-index: 10;
            transition: transform 0.15s ease-out; /* For jumping */
        }
        
        #dash-ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 10px;
            background: #475569; /* Slate 600 */
            z-index: 5;
        }

        .dash-obstacle {
            position: absolute;
            bottom: 10px;
            width: 15px;
            height: 30px;
            background: var(--danger);
            border: 2px solid #fff;
            clip-path: polygon(0% 100%, 50% 0%, 100% 100%);
            z-index: 8;
        }

        /* --- MODAL/ADMIN STYLES (Fixed) --- */
        .modal {
            position: fixed;
            z-index: 6000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: none; /* Default hidden */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--panel-bg);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--primary);
            width: 90%;
            max-width: 400px;
            border-radius: 10px;
        }
        .admin-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid var(--grey);
            background: #0f172a;
            color: white;
        }
        .admin-section {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
        }
        .admin-section:last-child { border-bottom: none; }
        .admin-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px;}
        .admin-row button { flex-grow: 1; }
        .admin-row label { width: 100px; font-size: 0.9rem; color: var(--grey); }

        @media (max-width: 600px) {
            header { padding-left: 10px; justify-content: space-between; margin-top: 40px; }
            #top-menu-btn { top: 10px; left: 10px; width: auto; }
            .currency-container { gap: 5px; flex-wrap: wrap; justify-content: flex-end;}
            .currency { font-size: 0.8rem; padding: 4px 8px; }
            .tab-btn { font-size: 0.75rem; }
            #event-hud { top: 65px; max-width: 90%; flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body class="theme-default">

    <div id="main-menu-overlay">
        <h1>COSMIC CLICKERS</h1>
        <div class="menu-stats">
            Current Shards: <span id="menu-shards">0</span> üíé<br>
            Total Rebirths: <span id="menu-rebirths">0</span> ‚ôªÔ∏è
        </div>
        <button class="menu-play-btn" onclick="startGame()">PLAY</button>
        <div style="margin-top:20px; font-size:0.8rem; color:#94a3b8">v3.6 - Space Dash</div>
    </div>

    <button id="top-menu-btn" onclick="openMainMenu()">‚ò∞ MENU</button>

    <div id="admin-trigger" onclick="openAdminModal()" style="position:fixed; top:0; right:0; width:50px; height:50px; z-index:100; opacity:0; cursor:pointer;"></div>

    <div id="particle-overlay"></div>

    <div id="event-hud">
        <strong id="hud-name">EVENT NAME</strong>
        <div class="hud-circle hud-mult"><span id="hud-mult">1X</span></div>
        <div class="hud-circle hud-time"><span id="hud-time">5:00</span></div>
    </div>

    <header>
        <div class="currency-container">
            <div class="currency">üñ±Ô∏è <span id="display-clicks">0</span></div>
            <div class="currency" style="color:#d8b4fe">üíé <span id="display-shards">0</span></div>
            <div class="currency" style="color:#fca5a5">‚ôªÔ∏è <span id="display-rebirths">0</span></div>
        </div>
    </header>

    <div id="game-area">
        <div style="margin-bottom: 10px; opacity: 0.8; font-size: 0.9rem; text-align: center;">
            <div id="active-skills">
                <button class="skill-btn" id="frenzy-btn" onclick="activateFrenzy()">Frenzy (2x)</button>
            </div>
            <div style="margin-bottom:5px;">Per Tap: <strong id="display-cpt" style="color:var(--green)">1</strong></div>
            <div>Auto: <strong id="display-cps" style="color:var(--secondary)">0</strong>/s</div>
        </div>
        <div id="clicker-btn"></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('upgrades')">Upgrades</button>
        <button class="tab-btn" onclick="switchTab('minigames')">Mini-Games</button>
        <button class="tab-btn" onclick="switchTab('leaderboard')">Leaderboard</button>
        <button class="tab-btn" onclick="switchTab('shards')">Shards</button>
        <button class="tab-btn" onclick="switchTab('themes')">Themes</button>
        <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
        <button class="tab-btn" onclick="switchTab('rebirth')" style="color: #fca5a5">Rebirth</button>
    </div>

    <div class="panel-container">
        
        <div id="panel-upgrades" class="panel active">
            <h3>Click Upgrades</h3>
            <div class="shop-item">
                <div>
                    <strong>Cosmic Ray</strong><br>
                    <small>Double click power</small>
                </div>
                <button class="btn-buy" id="btn-up-click" onclick="buyClickUpgrade()">Buy (<span id="cost-click">50</span>)</button>
            </div>

            <h3>Auto Clickers</h3>
            <div class="shop-item">
                <div>
                    <strong>Space Dust (Slow)</strong><br>
                    <small>+1 Click/sec</small>
                </div>
                <button class="btn-buy" onclick="buyAuto(0)">Buy (<span id="cost-auto-0">100</span>)</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Asteroid Miner (Med)</strong><br>
                    <small>+10 Clicks/sec</small>
                </div>
                <button class="btn-buy" onclick="buyAuto(1)">Buy (<span id="cost-auto-1">500</span>)</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Star Forge (Fast)</strong><br>
                    <small>+50 Clicks/sec</small>
                </div>
                <button class="btn-buy" onclick="buyAuto(2)">Buy (<span id="cost-auto-2">2000</span>)</button>
            </div>
        </div>

        <div id="panel-minigames" class="panel">
            
            <div class="mini-game-container">
                <h3>Cosmic Slots</h3>
                <p style="font-size:0.8rem">Match 3 symbols to win big! (Cost: 1000 Clicks)</p>
                <div id="slots">
                    <div class="slot-reel" id="reel-1">üöÄ</div>
                    <div class="slot-reel" id="reel-2">üöÄ</div>
                    <div class="slot-reel" id="reel-3">üöÄ</div>
                </div>
                <button class="btn-buy" style="width:100%" id="slot-btn" onclick="playSlots()">Spin!</button>
                <div id="slot-msg" style="margin-top:5px; height:20px; font-size:0.9rem;"></div>
            </div>

            <div class="mini-game-container">
                <h3>Memory Matrix</h3>
                <p style="font-size:0.8rem">Match the alien pairs! (Cost: 500 Clicks)</p>
                <div id="memory-grid">
                    </div>
                <button class="btn-buy" style="width:100%" id="memory-btn" onclick="startMemoryGame()">Start Hack</button>
            </div>
            
            <div class="mini-game-container">
                <h3>Space Dash</h3>
                <p style="font-size:0.8rem">Jump over spikes! Click/Tap to jump. Maximize score before crash! (Reward: Clicks/sec * Score)</p>
                <div id="space-dash-area" onclick="handleDashJump()">
                    <div id="dash-player"></div>
                    <div id="dash-ground"></div>
                    <div id="dash-score" style="position:absolute; top:10px; right:10px; font-weight:bold; z-index:100;">Score: 0</div>
                </div>
                <button class="btn-buy" style="width:100%" id="dash-btn" onclick="startDashGame()">Start Dash (Free)</button>
            </div>
        </div>
        
        <div id="panel-leaderboard" class="panel">
            <h3>Cosmic Leaderboard</h3>
            <p style="font-size:0.8rem; color:var(--primary);">Your best scores are saved on your device!</p>
            
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>High Score</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr><td>Clicks</td><td id="lb-clicks">0</td></tr>
                    <tr><td>Shards</td><td id="lb-shards">0</td></tr>
                    <tr><td>Rebirths</td><td id="lb-rebirths">0</td></tr>
                    <tr><td>Dash Score</td><td id="lb-dash">0</td></tr>
                </tbody>
            </table>
            <div class="shop-item" style="margin-top:20px;">
                <button class="btn-buy" style="background:var(--danger); width:100%" onclick="resetLeaderboard()">Reset Leaderboard</button>
            </div>
        </div>

        <div id="panel-shards" class="panel">
            <h3>Shard Shop (Permanent)</h3>
            <div class="shop-item">
                <div>
                    <strong>Efficient Rebirth (<span id="extraShardCount">0</span>)</strong><br>
                    <small>+1 Shard gained per Rebirth</small>
                </div>
                <button class="btn-buy" id="btn-shard-extraShard" onclick="buyShardUpgrade('extraShard')">Buy (5üíé)</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Starter Pack (<span id="startBonusStatus">Not Unlocked</span>)</strong><br>
                    <small>Start rebirths with 500 Clicks</small>
                </div>
                <button class="btn-buy" id="btn-shard-startBonus" onclick="buyShardUpgrade('startBonus')">Buy (10üíé)</button>
            </div>
        </div>

        <div id="panel-themes" class="panel">
            <h3>Theme Shop</h3>
            <p style="font-size:0.8rem">Base Colors: 1üíé | Gradients: 2üíé | Special: 5üíé</p>
            <div class="theme-grid" id="theme-grid"></div>
        </div>

        <div id="panel-settings" class="panel">
            <h3>Settings</h3>
            <div class="toggle-row">
                <span>SFX</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-sfx" onchange="toggleSetting('sfx')">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="toggle-row">
                <span>Music</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-music" onchange="toggleSetting('music')">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="shop-item">
                <button class="btn-buy" style="background:var(--danger); width:100%" onclick="hardReset()">Hard Reset Save</button>
            </div>
        </div>

        <div id="panel-rebirth" class="panel">
            <div style="text-align: center;">
                <h2 style="color:#fca5a5">Prestige</h2>
                <p style="font-size:0.9rem">Reset progress to earn <strong style="color:#d8b4fe">Asteroid Shards</strong>.</p>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; margin:10px 0;">
                    Shards to earn: <strong id="rebirth-earn" style="font-size:1.2rem">0</strong>üíé
                </div>
                <button class="btn-buy" style="font-size: 1.2em; padding: 15px; width:100%" onclick="doRebirth()">REBIRTH NOW</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-top:0; text-align:center;">üåå Admin Panel</h3>
            <div id="admin-login" style="text-align:center;">
                <input type="password" id="admin-pass" class="admin-input" placeholder="Enter 'Geforce13!'">
                <br>
                <div class="admin-row" style="justify-content:center;">
                    <button class="btn-buy" style="flex-grow:0; width:100px;" onclick="checkAdmin()">Unlock</button>
                    <button class="btn-buy" style="background:#475569; flex-grow:0; width:100px;" onclick="closeModal('admin-modal')">Close</button>
                </div>
            </div>
            
            <div id="admin-controls" style="display:none; text-align:left;">
                
                <div class="admin-section">
                    <h4>Currency Generation</h4>
                    <div class="admin-row">
                        <input type="number" id="admin-gen-val" class="admin-input" value="1000" style="flex-grow: 2;">
                        <button class="btn-buy" onclick="adminGen('clicks')">Clicks</button>
                        <button class="btn-buy" onclick="adminGen('shards')">Shards</button>
                    </div>
                </div>

                <div class="admin-section">
                    <h4>Auto Clicks/Sec Control</h4>
                    <div class="admin-row">
                        <label>Tier 1 (+1/s):</label>
                        <button class="btn-buy" style="background:var(--danger);" onclick="adminAuto(0, -1)">-1</button>
                        <span id="admin-auto-0" style="width: 30px; text-align: center; color: var(--secondary);">0</span>
                        <button class="btn-buy" onclick="adminAuto(0, 1)">+1</button>
                    </div>
                    <div class="admin-row">
                        <label>Tier 2 (+10/s):</label>
                        <button class="btn-buy" style="background:var(--danger);" onclick="adminAuto(1, -1)">-1</button>
                        <span id="admin-auto-1" style="width: 30px; text-align: center; color: var(--secondary);">0</span>
                        <button class="btn-buy" onclick="adminAuto(1, 1)">+1</button>
                    </div>
                    <div class="admin-row">
                        <label>Tier 3 (+50/s):</label>
                        <button class="btn-buy" style="background:var(--danger);" onclick="adminAuto(2, -1)">-1</button>
                        <span id="admin-auto-2" style="width: 30px; text-align: center; color: var(--secondary);">0</span>
                        <button class="btn-buy" onclick="adminAuto(2, 1)">+1</button>
                    </div>
                </div>

                <div class="admin-section">
                    <h4>Event Manager</h4>
                    <div class="admin-row">
                        <select id="admin-event-select" class="admin-input" style="flex-grow: 2;">
                            <option value="none">-- Select Event --</option>
                            <option value="candy-sage">Candy Sage (3x, 5min)</option>
                            <option value="grassland-joy">Grassland Joy (6x, 5min)</option>
                        </select>
                        <button class="btn-buy" onclick="adminRunEvent()">Run</button>
                    </div>
                </div>

                <button class="btn-buy" style="background:#475569; width:100%; margin-top:10px" onclick="closeModal('admin-modal')">Close Panel</button>
            </div>
        </div>
    </div>

    <div id="notification-area"></div>

    <script>
        /* --- GAME DATA --- */
        const defaultState = {
            clicks: 0, shards: 0, rebirths: 0, clickCost: 50, clickMultiplier: 1, autoClickers: [0, 0, 0],
            themesUnlocked: ['theme-default'], currentTheme: 'theme-default',
            shardUpgrades: { extraShard: 0, startBonus: false }, settings: { sfx: true, music: false },
            event: { active: false, name: null, multiplier: 1, duration: 0, endTime: 0, particles: null, originalTheme: 'theme-default' },
            cooldowns: { frenzy: 0, frenzyMax: 300, frenzyDuration: 30 }, 
            eventTimer: 0 
        };
        const defaultLeaderboard = { clicks: 0, shards: 0, rebirths: 0, dash: 0 };
        let leaderboard = JSON.parse(JSON.stringify(defaultLeaderboard));

        let game = JSON.parse(JSON.stringify(defaultState));
        const autoRates = [1, 10, 50]; 

        /* --- THEMES --- */
        const themes = [
            { id: 'theme-default', name: 'Cosmic', cost: 0, type: 'gradient', color: 'linear-gradient(135deg, #000, #434343)' },
            { id: 'theme-mars', name: 'Mars', cost: 1, type: 'plain', color: '#7f1d1d' },
            { id: 'theme-neptune', name: 'Neptune', cost: 1, type: 'plain', color: '#1e3a8a' },
            { id: 'theme-gold', name: 'Gold Rush', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #BF953F, #FCF6BA)' },
            { id: 'theme-nebula', name: 'Nebula', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #4c1d95, #db2777)' },
            { id: 'theme-matrix', name: 'Matrix', cost: 5, type: 'special', color: '#000' },
            { id: 'theme-lava', name: 'Lava', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #f43f5e, #f97316)' },
            { id: 'theme-aqua', name: 'Aqua', cost: 1, type: 'plain', color: '#06b6d4' },
            { id: 'theme-void', name: 'Void', cost: 1, type: 'plain', color: '#000000' },
            { id: 'theme-sunset', name: 'Sunset', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #fef08a, #f97316)' },
            { id: 'theme-silver', name: 'Silver', cost: 1, type: 'plain', color: '#6b7280' }
        ];

        /* --- AUDIO ENGINE --- */
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let musicTimer = null;
        let noteIndex = 0;
        let currentMusicType = 'none';
        let isDashPlaying = false; 

        function playTone(freq, type, duration, vol = 0.1) {
            if (!game.settings.sfx && !freq) return; 
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playHiHat() {
            if (!game.settings.sfx) return;
            const bufferSize = audioCtx.sampleRate * 0.05; 
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 5000;
            const gain = audioCtx.createGain();
            gain.gain.value = 0.05;
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start();
        }

        function musicLoop() {
            if (!game.settings.music) return;
            if (document.getElementById('main-menu-overlay').style.display !== 'none') return;

            if (currentMusicType === 'action') {
                const beat = noteIndex % 16;
                if (beat === 0) playTone(98.00, 'sawtooth', 0.4, 0.15); 
                if (beat === 3) playTone(98.00, 'sawtooth', 0.4, 0.15); 
                if (beat === 6) playTone(116.54, 'square', 0.2, 0.1);  
                if (beat === 8) playTone(130.81, 'square', 0.2, 0.1);  
                if (beat % 2 === 0) playHiHat();
            } 
            else if (currentMusicType === 'chill') {
                const beat = noteIndex % 32;
                if (beat === 0) playTone(196.00, 'triangle', 2, 0.05); 
                if (beat === 8) playTone(246.94, 'triangle', 2, 0.05); 
                if (beat === 16) playTone(293.66, 'triangle', 2, 0.05); 
                if (beat === 24) playTone(392.00, 'triangle', 2, 0.05); 
            }
            noteIndex++;
        }
        
        function updateMusicState() {
            if (!game.settings.music) {
                if (musicTimer) clearInterval(musicTimer);
                musicTimer = null;
                currentMusicType = 'none';
                return;
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const shouldBeAction = game.event.active || isDashPlaying;
            const targetType = shouldBeAction ? 'action' : 'chill';
            const interval = targetType === 'action' ? 150 : 250; 

            if (currentMusicType !== targetType) {
                if (musicTimer) clearInterval(musicTimer);
                noteIndex = 0;
                currentMusicType = targetType;
                musicTimer = setInterval(musicLoop, interval);
            }
        }

        function playClickSound() { if (game.settings.sfx) playTone(400 + Math.random() * 200, 'sine', 0.1, 0.1); }
        function playSkillSound() { if (game.settings.sfx) { playTone(600, 'square', 0.3, 0.1); setTimeout(() => playTone(800, 'square', 0.3, 0.1), 100); } }


        /* --- UI UTILITIES --- */
        function formatNum(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return Math.floor(num);
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function notify(msg) {
            const area = document.getElementById('notification-area');
            const d = document.createElement('div');
            d.className = 'notif';
            d.innerText = msg;
            area.appendChild(d);
            setTimeout(() => d.remove(), 2500);
        }

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-'+id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${id}')"]`).classList.add('active');
            
            if(id === 'leaderboard') renderLeaderboard();
        }

        /* --- MENU LOGIC --- */
        function startGame() {
            document.getElementById('main-menu-overlay').style.display = 'none';
            if (audioCtx.state === 'suspended') audioCtx.resume();
            updateMusicState();
        }

        function openMainMenu() {
            document.getElementById('main-menu-overlay').style.display = 'flex';
            document.getElementById('menu-shards').innerText = formatNum(game.shards);
            document.getElementById('menu-rebirths').innerText = formatNum(game.rebirths);
        }
        
        /* --- CORE LOGIC --- */
        function calculateClickPower() {
            let base = game.clickMultiplier * (game.rebirths + 1);
            let totalMult = base * game.event.multiplier; 
            if(game.cooldowns.frenzy > 0) totalMult *= 2; 
            return totalMult;
        }

        function calculateCPS() {
            let cps = 0;
            game.autoClickers.forEach((count, i) => cps += count * autoRates[i]);
            if(game.cooldowns.frenzy > 0) cps *= 2; 
            return cps;
        }

        function clickPlanet(e) {
            if(e) e.preventDefault(); 
            if(document.getElementById('main-menu-overlay').style.display === 'flex') return;
            game.clicks += calculateClickPower();
            playClickSound();
            updateDisplay();
            const btn = document.getElementById('clicker-btn');
            btn.style.transform = 'scale(0.92)';
            setTimeout(() => btn.style.transform = 'scale(1)', 50);
        }
        
        document.getElementById('clicker-btn').addEventListener('touchstart', (e) => { e.preventDefault(); clickPlanet(); }, {passive: false});
        document.getElementById('clicker-btn').addEventListener('mousedown', clickPlanet);

        function updateDisplay() {
            document.getElementById('display-clicks').innerText = formatNum(game.clicks);
            document.getElementById('display-shards').innerText = formatNum(game.shards);
            document.getElementById('display-rebirths').innerText = formatNum(game.rebirths);
            document.getElementById('display-cpt').innerText = formatNum(calculateClickPower());
            document.getElementById('display-cps').innerText = formatNum(calculateCPS());
            document.getElementById('rebirth-earn').innerText = formatNum(Math.floor(game.clicks / 2000) + game.shardUpgrades.extraShard);
            document.getElementById('menu-shards').innerText = formatNum(game.shards);
            document.getElementById('menu-rebirths').innerText = formatNum(game.rebirths);
            document.getElementById('cost-click').innerText = formatNum(game.clickCost);
            document.getElementById('cost-auto-0').innerText = formatNum(Math.floor(100 * Math.pow(1.1, game.autoClickers[0])));
            document.getElementById('cost-auto-1').innerText = formatNum(Math.floor(500 * Math.pow(1.1, game.autoClickers[1])));
            document.getElementById('cost-auto-2').innerText = formatNum(Math.floor(2000 * Math.pow(1.1, game.autoClickers[2])));

            const btn = document.getElementById('frenzy-btn');
            if (game.cooldowns.frenzy > 0) {
                btn.innerText = `Frenzy (${game.cooldowns.frenzy}s)`;
                btn.disabled = true;
                btn.style.backgroundColor = 'var(--green)'; // Active
            } else if (game.cooldowns.frenzy < 0) {
                btn.innerText = `Cooling (${Math.abs(game.cooldowns.frenzy)}s)`;
                btn.disabled = true;
                btn.style.backgroundColor = 'var(--cooldown-color)'; // Cooldown
            } else {
                btn.innerText = 'Frenzy (2x)';
                btn.disabled = false;
                btn.style.backgroundColor = 'var(--primary)'; // Ready
            }
            
            // Admin Panel Auto Clicker display
            if (document.getElementById('admin-auto-0')) document.getElementById('admin-auto-0').innerText = game.autoClickers[0];
            if (document.getElementById('admin-auto-1')) document.getElementById('admin-auto-1').innerText = game.autoClickers[1];
            if (document.getElementById('admin-auto-2')) document.getElementById('admin-auto-2').innerText = game.autoClickers[2];
            
            checkLeaderboard();
        }

        /* --- MINI-GAMES LOGIC (FULLY IMPLEMENTED) --- */
        
        // --- 1. SLOTS ---
        const slotSymbols = ['üöÄ', 'üëΩ', 'ü™ê', '‚≠êÔ∏è', '‚òÑÔ∏è'];
        let isSpinning = false;

        function playSlots() {
            if (isSpinning) return;
            const cost = 1000;
            if (game.clicks < cost) { notify("Not enough clicks!"); return; }
            
            game.clicks -= cost;
            updateDisplay();
            isSpinning = true;
            document.getElementById('slot-btn').disabled = true;
            document.getElementById('slot-msg').innerText = "Spinning...";

            const r1 = document.getElementById('reel-1');
            const r2 = document.getElementById('reel-2');
            const r3 = document.getElementById('reel-3');
            
            let spins = 0;
            const interval = setInterval(() => {
                r1.innerText = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                r2.innerText = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                r3.innerText = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                playTone(300, 'square', 0.05, 0.05); // Spin sound
                spins++;
                if(spins > 20) {
                    clearInterval(interval);
                    finalizeSlots();
                }
            }, 100);
        }

        function finalizeSlots() {
            const r1 = document.getElementById('reel-1');
            const r2 = document.getElementById('reel-2');
            const r3 = document.getElementById('reel-3');
            
            const v1 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            const v2 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            const v3 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            
            // Staggered stop effect
            setTimeout(() => { r1.innerText = v1; playTone(500, 'sine', 0.1); }, 0);
            setTimeout(() => { r2.innerText = v2; playTone(500, 'sine', 0.1); }, 300);
            setTimeout(() => { 
                r3.innerText = v3; 
                playTone(500, 'sine', 0.1); 
                checkSlotWin(v1, v2, v3);
            }, 600);
        }

        function checkSlotWin(v1, v2, v3) {
            isSpinning = false;
            document.getElementById('slot-btn').disabled = false;
            
            if (v1 === v2 && v2 === v3) {
                const reward = calculateClickPower() * 500;
                game.clicks += reward;
                game.shards += 1;
                document.getElementById('slot-msg').innerText = `JACKPOT! +${formatNum(reward)} Clicks & 1üíé`;
                document.getElementById('slot-msg').style.color = 'var(--green)';
                playSkillSound();
            } else if (v1 === v2 || v2 === v3 || v1 === v3) {
                const reward = calculateClickPower() * 50;
                game.clicks += reward;
                document.getElementById('slot-msg').innerText = `Mini Win! +${formatNum(reward)} Clicks`;
                document.getElementById('slot-msg').style.color = '#fff';
            } else {
                document.getElementById('slot-msg').innerText = "Try again!";
                document.getElementById('slot-msg').style.color = 'var(--grey)';
            }
            updateDisplay();
        }

        // --- 2. MEMORY MATRIX ---
        const memoryIcons = ['üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üíÄ', 'üëª', 'üê≤', 'üëπ'];
        let memoryGrid = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let isMemoryLocked = false;

        function startMemoryGame() {
            const cost = 500;
            if (document.getElementById('memory-btn').innerText === "Playing...") return;
            if (game.clicks < cost) { notify("Not enough clicks!"); return; }

            game.clicks -= cost;
            updateDisplay();
            
            // Setup Board
            const gridEl = document.getElementById('memory-grid');
            gridEl.innerHTML = '';
            flippedCards = [];
            matchedPairs = 0;
            isMemoryLocked = false;
            document.getElementById('memory-btn').innerText = "Playing...";
            document.getElementById('memory-btn').disabled = true;

            // Create pairs
            let deck = [...memoryIcons, ...memoryIcons];
            deck.sort(() => Math.random() - 0.5);

            deck.forEach((icon, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.icon = icon;
                card.dataset.index = index;
                const innerText = document.createElement('span');
                innerText.innerText = '?';
                card.appendChild(innerText);
                card.onclick = () => flipCard(card);
                gridEl.appendChild(card);
            });
        }

        function flipCard(card) {
            if (isMemoryLocked) return;
            if (card.classList.contains('flipped') || card.classList.contains('matched')) return;

            // Flip
            card.classList.add('flipped');
            card.querySelector('span').innerText = card.dataset.icon;
            flippedCards.push(card);
            playTone(600, 'sine', 0.1);

            if (flippedCards.length === 2) {
                isMemoryLocked = true;
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [c1, c2] = flippedCards;
            if (c1.dataset.icon === c2.dataset.icon) {
                // Match
                playTone(800, 'square', 0.1);
                c1.classList.add('matched');
                c2.classList.add('matched');
                c1.querySelector('span').innerText = c1.dataset.icon; // Ensure matched state shows icon
                c2.querySelector('span').innerText = c2.dataset.icon;
                matchedPairs++;
                flippedCards = [];
                isMemoryLocked = false;
                
                if (matchedPairs === 8) {
                    const reward = calculateClickPower() * 800;
                    notify(`HACK COMPLETE! +${formatNum(reward)} Clicks`);
                    game.clicks += reward;
                    updateDisplay();
                    document.getElementById('memory-btn').innerText = "Start Hack";
                    document.getElementById('memory-btn').disabled = false;
                }
            } else {
                // No Match
                setTimeout(() => {
                    c1.classList.remove('flipped');
                    c1.querySelector('span').innerText = '?';
                    c2.classList.remove('flipped');
                    c2.querySelector('span').innerText = '?';
                    flippedCards = [];
                    isMemoryLocked = false;
                }, 800);
            }
        }
        
        // --- 3. SPACE DASH ---
        let playerY = 10; 
        const gravity = 1;
        const jumpVelocity = 15;
        let velocityY = 0;
        let obstacleSpeed = 2; 
        let dashInterval;
        let obstacleInterval;
        let dashScore = 0;

        const dashArea = document.getElementById('space-dash-area');
        const dashPlayer = document.getElementById('dash-player');
        const dashButton = document.getElementById('dash-btn');
        const dashGround = document.getElementById('dash-ground');
        const dashScoreEl = document.getElementById('dash-score');

        function startDashGame() {
            if (isDashPlaying) return;

            isDashPlaying = true;
            dashScore = 0;
            playerY = 10;
            velocityY = 0;
            obstacleSpeed = 2;
            dashPlayer.style.transform = 'translateY(0px)';
            
            // Re-append elements to ensure they are available after panel switch
            dashArea.innerHTML = '';
            dashArea.appendChild(dashPlayer);
            dashArea.appendChild(dashGround);
            dashArea.appendChild(dashScoreEl);
            dashScoreEl.innerText = 'Score: 0';

            dashButton.innerText = "Playing...";
            dashButton.disabled = true;
            updateMusicState(); 

            dashInterval = setInterval(gameLoopDash, 20); 
            obstacleInterval = setInterval(spawnObstacle, 1500); 
        }

        function handleDashJump() {
            if (!isDashPlaying) return;
            if (playerY <= 10) { 
                velocityY = jumpVelocity;
                playTone(900, 'square', 0.1); 
            }
        }

        function spawnObstacle() {
            if (!isDashPlaying) return;
            const obs = document.createElement('div');
            obs.className = 'dash-obstacle';
            obs.style.right = '-20px';
            dashArea.appendChild(obs);
        }

        function updateObstacles() {
            const obstacles = dashArea.querySelectorAll('.dash-obstacle');
            const playerRect = dashPlayer.getBoundingClientRect();
            const areaRect = dashArea.getBoundingClientRect();
            
            obstacleSpeed = 2 + Math.floor(dashScore / 50) * 0.5; 

            for (let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                let currentRight = parseFloat(obs.style.right);
                obs.style.right = (currentRight + obstacleSpeed) + 'px';

                // Get dynamic position for collision check
                const obsCurrentX = areaRect.width - (currentRight + obstacleSpeed) - obs.offsetWidth;
                const playerCurrentX = 20; // Player is fixed at 20px left

                // Check for collision (X-overlap and Y-overlap)
                const isOverlappingX = (playerCurrentX + dashPlayer.offsetWidth) > obsCurrentX && playerCurrentX < (obsCurrentX + obs.offsetWidth);
                const isCollidingY = playerY <= (obs.offsetHeight + 10); // 10 is the height of dash-ground

                if (isOverlappingX && isCollidingY) {
                    endDashGame(false);
                    return; 
                }

                // Obstacle passed
                if (currentRight > areaRect.width) {
                    obs.remove();
                    dashScore++;
                    dashScoreEl.innerText = 'Score: ' + dashScore;
                }
            }
        }

        function gameLoopDash() {
            if (!isDashPlaying) return;

            // Apply gravity/jump
            velocityY -= gravity;
            playerY += velocityY;
            
            if (playerY < 10) {
                playerY = 10;
                velocityY = 0;
            }
            
            dashPlayer.style.transform = `translateY(-${playerY - 10}px)`;

            updateObstacles();

            if (dashScore >= 100) {
                endDashGame(true);
            }
        }

        function endDashGame(won) {
            isDashPlaying = false;
            clearInterval(dashInterval);
            clearInterval(obstacleInterval);
            dashButton.innerText = "Start Dash (Free)";
            dashButton.disabled = false;
            
            const reward = calculateCPS() * dashScore;
            
            if (won) {
                game.clicks += reward;
                notify(`LEVEL COMPLETE! +${formatNum(reward)} Clicks!`);
            } else {
                notify(`DASH FAILED! Score: ${dashScore}. Reward: +${formatNum(reward)} Clicks.`);
                game.clicks += reward;
            }
            
            if (dashScore > leaderboard.dash) {
                leaderboard.dash = dashScore;
                notify(`New Dash High Score: ${dashScore}!`);
            }
            
            updateDisplay();
            dashArea.querySelectorAll('.dash-obstacle').forEach(obs => obs.remove());
            updateMusicState(); 
        }

        /* --- LEADERBOARD --- */
        function checkLeaderboard() {
            let updated = false;
            if (game.clicks > leaderboard.clicks) { leaderboard.clicks = game.clicks; updated = true; }
            if (game.shards > leaderboard.shards) { leaderboard.shards = game.shards; updated = true; }
            if (game.rebirths > leaderboard.rebirths) { leaderboard.rebirths = game.rebirths; updated = true; }
            
            if (updated) saveLeaderboard();
        }

        function renderLeaderboard() {
            document.getElementById('lb-clicks').innerText = formatNum(leaderboard.clicks);
            document.getElementById('lb-shards').innerText = formatNum(leaderboard.shards);
            document.getElementById('lb-rebirths').innerText = formatNum(leaderboard.rebirths);
            document.getElementById('lb-dash').innerText = leaderboard.dash;
        }

        function resetLeaderboard() {
            if (confirm("Are you sure you want to reset all high scores?")) {
                leaderboard = JSON.parse(JSON.stringify(defaultLeaderboard));
                saveLeaderboard();
                renderLeaderboard();
                notify("Leaderboard reset.");
            }
        }


        /* --- SHOP ACTIONS --- */
        function buyClickUpgrade() {
            if (game.clicks >= game.clickCost) {
                game.clicks -= game.clickCost;
                game.clickMultiplier *= 2;
                game.clickCost = Math.floor(game.clickCost * 2);
                updateDisplay();
            } else { notify("Not enough clicks to buy Cosmic Ray!"); }
        }
        function buyAuto(index) {
            const cost = Math.floor((index === 0 ? 100 : index === 1 ? 500 : 2000) * Math.pow(1.1, game.autoClickers[index]));
            if (game.clicks >= cost) {
                game.clicks -= cost;
                game.autoClickers[index]++;
                updateDisplay();
            } else { notify("Not enough clicks to buy auto clicker!"); }
        }
        function buyShardUpgrade(type) {
            const cost = (type === 'extraShard') ? 5 : 10;
            if (game.shards >= cost) {
                game.shards -= cost;
                if (type === 'extraShard') { 
                    game.shardUpgrades.extraShard++; 
                    document.getElementById('btn-shard-extraShard').innerText = `Buy (5üíé)`;
                }
                else if (type === 'startBonus') { game.shardUpgrades.startBonus = true; }
                updateDisplay();
                document.getElementById('extraShardCount').innerText = game.shardUpgrades.extraShard;
                document.getElementById('startBonusStatus').innerText = game.shardUpgrades.startBonus ? 'Unlocked' : 'Locked';
            } else { notify("Not enough shards for this upgrade!"); }
        }
        function doRebirth() {
            let gain = Math.floor(game.clicks / 2000);
            if(gain > 0) gain += game.shardUpgrades.extraShard;
            
            if (gain > 0) {
                if (!confirm(`Are you sure you want to Rebirth? You will gain ${gain} üíé shards.`)) return;
                
                game.shards += gain;
                game.rebirths++;
                const keep = { shards: game.shards, rebirths: game.rebirths, themesUnlocked: game.themesUnlocked, currentTheme: game.currentTheme, shardUpgrades: game.shardUpgrades, settings: game.settings };
                game = { ...defaultState, ...keep };
                if (game.shardUpgrades.startBonus) game.clicks = 500;
                endEvent();
                notify(`Rebirth successful! Gained ${gain} üíé.`);
                updateDisplay();
            } else {
                 notify("Need at least 2,000 Clicks to gain 1 Shard.");
            }
        }

        /* --- EVENT SYSTEM --- */
        const eventData = {
            'candy-sage': { name: 'Candy Sage', mult: 3, duration: 300, theme: 'event-candy-sage', particles: { count: 30, color: '#fbcfe8', shape: 'üç¨', size: 10 } },
            'grassland-joy': { name: 'Grassland Joy', mult: 6, duration: 300, theme: 'event-grassland-joy', particles: { count: 50, color: '#4ade80', shape: 'üåø', size: 8 } }
        };

        function startEvent(key) {
            if (game.event.active || key === 'none') return;
            const data = eventData[key];
            game.event.active = true;
            game.event.name = data.name;
            game.event.multiplier = data.mult;
            game.event.duration = data.duration;
            game.event.endTime = Date.now() + (data.duration * 1000);
            game.event.originalTheme = document.body.className;

            document.body.className = data.theme;
            
            const hud = document.getElementById('event-hud');
            document.getElementById('hud-name').innerText = data.name;
            document.getElementById('hud-mult').innerText = data.mult + 'X';
            hud.classList.add('active');

            startParticles(data.particles);
            updateMusicState(); 
            notify(data.name + " Event Started!");
        }

        function endEvent() {
            if (!game.event.active) return;
            document.body.className = game.event.originalTheme || 'theme-default'; 
            game.event.active = false;
            game.event.multiplier = 1;
            document.getElementById('event-hud').classList.remove('active');
            stopParticles();
            
            game.eventTimer = 0; 
            updateMusicState(); 
            notify("Event Ended.");
        }

        function startParticles(opts) {
            stopParticles();
            const overlay = document.getElementById('particle-overlay');
            const styleSheet = document.styleSheets[0];
            const kfName = `fall-${opts.shape.charCodeAt(0)}`;
            let ruleExists = Array.from(styleSheet.cssRules).some(r => r.name === kfName);
            if (!ruleExists) {
                // Simplified keyframe injection (only works if CSS rule count is under browser limit)
                const keyframes = `@keyframes ${kfName} { 0% { transform: translateY(-100px) rotate(0deg); } 100% { transform: translateY(100vh) rotate(360deg); } }`;
                try {
                    styleSheet.insertRule(keyframes, styleSheet.cssRules.length);
                } catch(e) { /* Ignore error if rule already exists or browser limit reached */ }
            }
            for(let i=0; i<opts.count; i++) {
                const p = document.createElement('div');
                p.innerText = opts.shape;
                p.style.position = 'absolute';
                p.style.color = opts.color;
                p.style.fontSize = opts.size + 'px';
                p.style.left = Math.random()*100 + 'vw';
                p.style.top = Math.random()*-100 + 'px';
                p.style.animation = `${kfName} ${5+Math.random()*5}s linear infinite`;
                overlay.appendChild(p);
            }
        }
        function stopParticles() { document.getElementById('particle-overlay').innerHTML = ''; }

        /* --- THEMES & EXTRAS --- */
        function renderThemes() {
            const grid = document.getElementById('theme-grid');
            grid.innerHTML = '';
            themes.forEach(t => {
                const unlocked = game.themesUnlocked.includes(t.id);
                const d = document.createElement('div');
                d.className = `theme-item ${unlocked?'':'locked'} ${game.currentTheme===t.id?'active-theme':''}`;
                d.style.background = t.color;
                d.innerText = t.name + (unlocked ? '' : `\n(${t.cost}üíé)`);
                d.onclick = () => {
                    if(unlocked) { document.body.className = t.id; game.currentTheme = t.id; renderThemes(); }
                    else if(game.shards >= t.cost) { 
                        game.shards -= t.cost; 
                        game.themesUnlocked.push(t.id); 
                        document.body.className = t.id; 
                        game.currentTheme = t.id; 
                        renderThemes(); 
                        updateDisplay(); 
                    } else { notify("Not enough shards to unlock theme!"); }
                };
                grid.appendChild(d);
            });
        }
        function toggleSetting(s) { 
            game.settings[s] = document.getElementById(`toggle-${s}`).checked; 
            if(s==='music') updateMusicState();
        }
        function activateFrenzy() {
            if(game.cooldowns.frenzy === 0) { 
                game.cooldowns.frenzy = 30; 
                playSkillSound(); 
                notify("Frenzy Activated! (2x Boost)");
                updateDisplay();
            }
        }
        function spawnGoldenPlanet() {
            const p = document.createElement('div');
            p.className = 'golden-planet';
            p.style.position = 'absolute';
            p.style.background = 'radial-gradient(circle, #ffd700, #ff8c00)';
            p.style.width = '40px';
            p.style.height = '40px';
            p.style.borderRadius = '50%';
            p.style.boxShadow = '0 0 10px #ffd700';
            p.style.cursor = 'pointer';
            p.style.left = Math.random() * (window.innerWidth - 60) + 'px';
            p.style.top = Math.random() * (window.innerHeight - 200) + 100 + 'px';
            p.style.zIndex = '50';
            p.onclick = () => {
                game.clicks += calculateClickPower() * 1000;
                game.shards += 1;
                playSkillSound();
                p.remove();
                notify("Golden Planet Found! +1000x Tap & 1üíé");
                updateDisplay();
            };
            document.getElementById('game-area').appendChild(p);
            setTimeout(() => { if(p.parentNode) p.remove(); }, 15000);
        }

        /* --- GAME LOOPS --- */
        setInterval(() => {
            if (document.getElementById('main-menu-overlay').style.display === 'none') {
                game.clicks += calculateCPS();
            }
            
            if(game.event.active) {
                const remaining = Math.max(0, Math.floor((game.event.endTime - Date.now()) / 1000));
                document.getElementById('hud-time').innerText = formatTime(remaining);
                if(remaining <= 0) endEvent();
            } else {
                game.eventTimer++;
                // Check for event trigger only if event is not active and game is running
                if(game.eventTimer >= 600 && document.getElementById('main-menu-overlay').style.display === 'none') { 
                    // Randomly select one of the two defined events
                    const eventKeys = Object.keys(eventData).filter(k => k !== 'none');
                    startEvent(eventKeys[Math.floor(Math.random() * eventKeys.length)]);
                }
            }

            if(game.cooldowns.frenzy > 0) {
                game.cooldowns.frenzy--;
                if(game.cooldowns.frenzy === 0) game.cooldowns.frenzy = -300;
            } else if (game.cooldowns.frenzy < 0) {
                game.cooldowns.frenzy++;
            }

            if(Math.random() < 0.01 && !document.querySelector('.golden-planet') && document.getElementById('main-menu-overlay').style.display === 'none') {
                spawnGoldenPlanet();
            }
            updateDisplay();
        }, 1000);

        /* --- ADMIN --- */
        function openAdminModal() { 
            document.getElementById('admin-modal').style.display = 'flex'; 
            document.getElementById('admin-auto-0').innerText = game.autoClickers[0];
            document.getElementById('admin-auto-1').innerText = game.autoClickers[1];
            document.getElementById('admin-auto-2').innerText = game.autoClickers[2];
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function checkAdmin() {
            if(document.getElementById('admin-pass').value === 'Geforce13!') {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-controls').style.display = 'block';
                notify("Admin Mode Unlocked");
            } else {
                notify("Incorrect Password");
            }
        }
        function adminRunEvent() { startEvent(document.getElementById('admin-event-select').value); closeModal('admin-modal'); }
        function adminGen(t) { 
            const val = parseInt(document.getElementById('admin-gen-val').value);
            if(isNaN(val)) { notify("Invalid amount."); return; }
            if(t==='clicks') game.clicks += val;
            if(t==='shards') game.shards += val;
            updateDisplay();
        }
        function adminAuto(index, change) {
            if (game.autoClickers[index] + change >= 0) {
                game.autoClickers[index] += change;
                updateDisplay();
            } else {
                notify("Cannot go below zero.");
            }
        }
        
        function hardReset() {
            if (confirm("Are you sure? This will wipe everything!")) {
                localStorage.removeItem('cosmicClickerSave');
                localStorage.removeItem('cosmicClickerLeaderboard');
                game = JSON.parse(JSON.stringify(defaultState));
                leaderboard = JSON.parse(JSON.stringify(defaultLeaderboard));
                endEvent();
                updateDisplay();
                renderThemes();
                renderLeaderboard();
                openMainMenu();
                window.location.reload(); 
            }
        }

        /* --- SAVE/LOAD --- */
        function saveLeaderboard() { localStorage.setItem('cosmicClickerLeaderboard', JSON.stringify(leaderboard)); }
        function loadLeaderboard() {
            const s = localStorage.getItem('cosmicClickerLeaderboard');
            if(s) leaderboard = { ...defaultLeaderboard, ...JSON.parse(s) };
        }

        function saveGame() { 
            localStorage.setItem('cosmicClickerSave', JSON.stringify(game)); 
            saveLeaderboard();
        }
        
        function loadGame() {
            loadLeaderboard();

            const s = localStorage.getItem('cosmicClickerSave');
            if(s) {
                const p = JSON.parse(s);
                // Merge loaded state with default state to handle new properties
                game = { ...defaultState, ...p };
                game.shardUpgrades = { ...defaultState.shardUpgrades, ...(p.shardUpgrades || {}) };
                game.settings = { ...defaultState.settings, ...(p.settings || {}) };
                game.event = { ...defaultState.event, ...(p.event||{}) };
                
                // Event check on load
                if(game.event.active) {
                    const rem = game.event.endTime - Date.now();
                    if(rem > 0) {
                        const eventKey = game.event.name ? game.event.name.toLowerCase().replace(/\s/g, '-') : null;
                        const d = eventData[eventKey];
                        if (d) {
                            document.body.className = d.theme;
                            document.getElementById('event-hud').classList.add('active');
                            document.getElementById('hud-name').innerText = d.name;
                            document.getElementById('hud-mult').innerText = d.mult + 'X';
                            startParticles(d.particles);
                        } else {
                            endEvent(); // Invalid event data
                        }
                    } else endEvent();
                } else {
                    // Important: Ensure the body class is set correctly even if no event is active
                    document.body.className = game.currentTheme;
                }
            }
            
            document.getElementById('toggle-sfx').checked = game.settings.sfx;
            document.getElementById('toggle-music').checked = game.settings.music;
            renderThemes();
            renderLeaderboard();
            updateDisplay();
            updateMusicState();
            
            // Set initial button states for shard upgrades
            document.getElementById('extraShardCount').innerText = game.shardUpgrades.extraShard;
            document.getElementById('startBonusStatus').innerText = game.shardUpgrades.startBonus ? 'Unlocked' : 'Locked';

            openMainMenu();
        }

        window.onload = loadGame;
        setInterval(saveGame, 30000);
    </script>
</body>
</html>
