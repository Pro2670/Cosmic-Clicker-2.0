<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Clickers - Minigame Update</title>
    <style>
        /* --- CSS VARIABLES & BASE --- */
        :root {
            --primary: #a855f7; /* Violet */
            --secondary: #3b82f6; /* Blue */
            --bg-color: #0f172a; /* Slate 900 */
            --panel-bg: rgba(30, 41, 59, 0.95); /* Slate 800 transparent */
            --text-color: #f8fafc; /* White */
            --green: #22c55e; /* Green 500 */
            --grey: #94a3b8; /* Slate 400 */
            --danger: #ef4444; /* Red 500 */
            --cooldown-color: #f97316; /* Orange */
            --leaderboard-bg: #1e293b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            transition: background 0.5s ease;
            user-select: none;
            background: linear-gradient(135deg, #000000, #434343);
            position: relative;
        }

        /* --- THEMES --- */
        body.theme-default { background: linear-gradient(135deg, #000000, #434343); }
        body.theme-mars { background: #7f1d1d; }
        body.theme-neptune { background: #1e3a8a; }
        body.theme-gold { background: linear-gradient(135deg, #BF953F, #FCF6BA); }
        body.theme-nebula { background: linear-gradient(135deg, #4c1d95, #db2777); }
        body.theme-matrix { background: #000000; color: #0f0; }
        body.theme-lava { background: linear-gradient(135deg, #f43f5e, #f97316); }
        body.theme-aqua { background: #06b6d4; }
        body.theme-void { background: #000000; }
        body.theme-sunset { background: linear-gradient(135deg, #fef08a, #f97316); }
        body.theme-silver { background: #6b7280; }
        
        /* EVENT THEMES */
        body.event-candy-sage { background: linear-gradient(135deg, #fbcfe8, #a5b4fc); }
        body.event-grassland-joy { background: linear-gradient(135deg, #4ade80, #78350f); }

        /* --- MAIN MENU --- */
        #main-menu-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        #main-menu-overlay h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
            animation: floatText 3s ease-in-out infinite;
        }

        @keyframes floatText {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .menu-play-btn {
            font-size: 1.5rem;
            padding: 15px 50px;
            background: var(--green);
            border: none;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px var(--green);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 30px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .menu-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px var(--green);
        }

        .menu-stats {
            margin-top: 20px;
            color: var(--grey);
            font-size: 0.9rem;
        }

        /* --- TOP LEFT MENU BUTTON --- */
        #top-menu-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 20;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* --- HEADER & CURRENCY --- */
        header {
            width: 100%;
            padding: 15px;
            padding-left: 100px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        .currency-container { 
            display: flex; 
            gap: 15px; 
            font-weight: bold; 
            font-size: 0.9rem; 
        }
        .currency {
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
        }

        /* --- MAIN CLICK AREA --- */
        #game-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
            position: relative;
        }

        #clicker-btn {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--primary), #000);
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 50px var(--primary);
            cursor: pointer;
            position: relative;
            touch-action: manipulation;
            -webkit-user-select: none;
            transition: transform 0.1s;
        }

        /* --- TABS & PANELS --- */
        .tabs {
            display: flex;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            flex-grow: 1;
            padding: 12px 0;
            background: transparent;
            border: none;
            color: var(--grey);
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s, background 0.2s;
            font-size: 0.85rem;
        }

        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active { color: var(--primary); box-shadow: inset 0 -3px 0 0 var(--primary); }

        .panel-container {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            background: var(--panel-bg);
            padding: 10px;
        }

        .panel { display: none; padding: 10px; }
        .panel.active { display: block; }

        /* --- SHOP ITEMS --- */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: background 0.2s;
        }

        .shop-item strong { color: var(--secondary); font-size: 1rem; }
        .shop-item small { color: var(--grey); font-size: 0.75rem; }

        .btn-buy {
            padding: 8px 15px;
            background: var(--green);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; background: var(--cooldown-color); }
        
        /* --- SETTINGS/TOGGLES --- */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* --- LEADERBOARD (FEATS) --- */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-top: 10px;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .leaderboard-table th {
            color: var(--primary);
            font-size: 0.9rem;
            background: var(--leaderboard-bg);
        }
        .leaderboard-table td:first-child { font-weight: bold; } /* Rank */
        .leaderboard-table tr:nth-child(even) { background: rgba(0,0,0,0.1); }
        .leaderboard-table .highlight-row { background: rgba(168, 85, 247, 0.2); }
        
        /* --- MINI-GAMES --- */
        .mini-game-container {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Slots */
        #slots {
            display: flex; justify-content: center; gap: 5px;
            margin-bottom: 15px; font-size: 2.5rem; font-weight: bold;
            height: 60px; overflow: hidden;
        }
        .slot-reel {
            width: 60px; background: #0f172a;
            border: 2px solid var(--secondary);
            border-radius: 5px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* Memory Matrix */
        #memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 15px;
            perspective: 1000px;
        }
        .memory-card {
            background: var(--secondary);
            height: 50px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            transform: scale(1);
            transition: transform 0.2s, background 0.3s;
            user-select: none;
        }
        .memory-card.flipped {
            background: var(--bg-color);
            border: 1px solid var(--primary);
            cursor: default;
        }
        .memory-card.matched {
            background: var(--green);
            opacity: 0.5;
            cursor: default;
        }

        /* Space Jump (New Game) */
        #space-jump-container {
            width: 100%;
            height: 150px;
            background: #000;
            overflow: hidden;
            position: relative;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 3px solid var(--secondary);
        }
        #space-jump-ground {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 10px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }
        #jump-player {
            position: absolute;
            bottom: 10px; left: 20px;
            width: 25px; height: 25px;
            background: var(--green);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #000;
            transition: transform 0.1s;
        }
        .jump-obstacle {
            position: absolute;
            bottom: 10px;
            width: 20px; 
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }
        #jump-score {
            position: absolute;
            top: 5px; right: 5px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        #jump-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
        }


        @media (max-width: 600px) {
            header { padding-left: 10px; justify-content: space-between; margin-top: 40px; }
            #top-menu-btn { top: 10px; left: 10px; width: auto; }
            .currency-container { gap: 5px; flex-wrap: wrap; justify-content: flex-end;}
            .currency { font-size: 0.8rem; padding: 4px 8px; }
            .skill-btn { width: 90px; height: 35px; font-size: 0.8rem; padding: 5px; }
            .tab-btn { font-size: 0.75rem; }
        }
    </style>
</head>
<body class="theme-default">

    <div id="main-menu-overlay">
        <h1>COSMIC CLICKERS</h1>
        <div class="menu-stats">
            Current Shards: <span id="menu-shards">0</span> üíé<br>
            Total Rebirths: <span id="menu-rebirths">0</span> ‚ôªÔ∏è
        </div>
        <button class="menu-play-btn" onclick="startGame()">PLAY</button>
        <div style="margin-top:20px; font-size:0.8rem; color:#94a3b8">v3.6 - Space Jump & Feats</div>
    </div>

    <button id="top-menu-btn" onclick="openMainMenu()">‚ò∞ MENU</button>

    <div id="admin-trigger" onclick="openAdminModal()"></div>

    <div id="particle-overlay"></div>

    <div id="event-hud">
        <strong style="color:var(--text-color);"><span id="hud-name"></span></strong>
        <div class="hud-circle hud-mult"><span id="hud-mult"></span></div>
        <div class="hud-circle hud-time"><span id="hud-time"></span></div>
    </div>

    <header>
        <div class="currency-container">
            <div class="currency">üñ±Ô∏è <span id="display-clicks">0</span></div>
            <div class="currency" style="color:#d8b4fe">üíé <span id="display-shards">0</span></div>
            <div class="currency" style="color:#fca5a5">‚ôªÔ∏è <span id="display-rebirths">0</span></div>
        </div>
    </header>

    <div id="game-area">
        <div style="margin-bottom: 10px; opacity: 0.8; font-size: 0.9rem; text-align: center;">
            <div id="active-skills">
                <button class="skill-btn" id="frenzy-btn" onclick="activateFrenzy()">Frenzy (2x)</button>
            </div>
            <div style="margin-bottom:5px;">Per Tap: <strong id="display-cpt" style="color:var(--green)">1</strong></div>
            <div>Auto: <strong id="display-cps" style="color:var(--secondary)">0</strong>/s</div>
        </div>
        <div id="clicker-btn"></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('upgrades')">Upgrades</button>
        <button class="tab-btn" onclick="switchTab('minigames')">Mini-Games</button>
        <button class="tab-btn" onclick="switchTab('shards')">Shards</button>
        <button class="tab-btn" onclick="switchTab('themes')">Themes</button>
        <button class="tab-btn" onclick="switchTab('feats')">Feats</button>
        <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
        <button class="tab-btn" onclick="switchTab('rebirth')" style="color: #fca5a5">Rebirth</button>
    </div>

    <div class="panel-container">
        
        <div id="panel-upgrades" class="panel active">
            <h3>Click Upgrades</h3>
            <div class="shop-item">
                <div>
                    <strong>Cosmic Ray</strong><br>
                    <small>Double click power</small>
                </div>
                <button class="btn-buy" id="btn-up-click" onclick="buyClickUpgrade()">Buy (<span id="cost-click">50</span>)</button>
            </div>

            <h3>Auto Clickers</h3>
            <div class="shop-item">
                <div>
                    <strong>Space Dust (Slow)</strong><br>
                    <small>+1 Click/sec</small>
                </div>
                <button class="btn-buy" onclick="buyAuto(0)">Buy (<span id="cost-auto-0">100</span>)</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Asteroid Miner (Med)</strong><br>
                    <small>+10 Clicks/sec</small>
                </div>
                <button class="btn-buy" onclick="buyAuto(1)">Buy (<span id="cost-auto-1">500</span>)</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Star Forge (Fast)</strong><br>
                    <small>+50 Clicks/sec</small>
                </div>
                <button class="btn-buy" onclick="buyAuto(2)">Buy (<span id="cost-auto-2">2000</span>)</button>
            </div>
        </div>

        <div id="panel-minigames" class="panel">
            
            <div class="mini-game-container">
                <h3>Space Jump</h3>
                <p style="font-size:0.8rem">Click to jump! Avoid the spikes to win a massive click bonus. (Cost: 1000 Clicks)</p>
                <div id="space-jump-container" onclick="jumpGameJump()">
                    <div id="space-jump-ground"></div>
                    <div id="jump-player">üöÄ</div>
                    <div id="jump-score">Score: 0</div>
                    <div id="jump-msg" style="color:var(--green)">Click to Start!</div>
                </div>
                <button class="btn-buy" style="width:100%" id="jump-btn" onclick="startJumpGame()">Play Space Jump</button>
            </div>

            <div class="mini-game-container">
                <h3>Cosmic Slots</h3>
                <p style="font-size:0.8rem">Match 3 symbols to win big! (Cost: 1000 Clicks)</p>
                <div id="slots">
                    <div class="slot-reel" id="reel-1">üöÄ</div>
                    <div class="slot-reel" id="reel-2">üöÄ</div>
                    <div class="slot-reel" id="reel-3">üöÄ</div>
                </div>
                <button class="btn-buy" style="width:100%" id="slot-btn" onclick="playSlots()">Spin!</button>
                <div id="slot-msg" style="margin-top:5px; height:20px; font-size:0.9rem;"></div>
            </div>

            <div class="mini-game-container">
                <h3>Memory Matrix</h3>
                <p style="font-size:0.8rem">Match the alien pairs! (Cost: 500 Clicks)</p>
                <div id="memory-grid">
                    </div>
                <button class="btn-buy" style="width:100%" id="memory-btn" onclick="startMemoryGame()">Start Hack</button>
            </div>
        </div>

        <div id="panel-shards" class="panel">
            <h3>Shard Shop (Permanent)</h3>
            <div class="shop-item">
                <div>
                    <strong>Efficient Rebirth (<span id="extraShardCount">0</span>)</strong><br>
                    <small>+1 Shard gained per Rebirth</small>
                </div>
                <button class="btn-buy" id="btn-shard-extraShard" onclick="buyShardUpgrade('extraShard')">Buy (5üíé)</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Starter Pack (<span id="startBonusStatus">Not Unlocked</span>)</strong><br>
                    <small>Start rebirths with 500 Clicks</small>
                </div>
                <button class="btn-buy" id="btn-shard-startBonus" onclick="buyShardUpgrade('startBonus')">Buy (10üíé)</button>
            </div>
        </div>

        <div id="panel-themes" class="panel">
            <h3>Theme Shop</h3>
            <p style="font-size:0.8rem">Base Colors: 1üíé | Gradients: 2üíé | Special: 5üíé</p>
            <div class="theme-grid" id="theme-grid"></div>
        </div>

        <div id="panel-feats" class="panel">
            <h3>Local Leaderboard</h3>
            <p style="font-size:0.8rem; color:var(--grey)">Your top lifetime achievements.</p>
            
            <h4 style="color:var(--green)">Top Clicks (Lifetime)</h4>
            <table class="leaderboard-table">
                <thead><tr><th>Rank</th><th>Score</th></tr></thead>
                <tbody id="lb-clicks"></tbody>
            </table>

            <h4 style="color:var(--primary)">Top Shards (Held)</h4>
            <table class="leaderboard-table">
                <thead><tr><th>Rank</th><th>Score</th></tr></thead>
                <tbody id="lb-shards"></tbody>
            </table>

            <h4 style="color:#fca5a5">Top Rebirths</h4>
            <table class="leaderboard-table">
                <thead><tr><th>Rank</th><th>Score</th></tr></thead>
                <tbody id="lb-rebirths"></tbody>
            </table>
        </div>

        <div id="panel-settings" class="panel">
            <h3>Settings</h3>
            <div class="toggle-row">
                <span>SFX</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-sfx" onchange="toggleSetting('sfx')">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="toggle-row">
                <span>Music</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-music" onchange="toggleSetting('music')">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="shop-item">
                <button class="btn-buy" style="background:var(--danger); width:100%" onclick="hardReset()">Hard Reset Save</button>
            </div>
        </div>

        <div id="panel-rebirth" class="panel">
            <div style="text-align: center;">
                <h2 style="color:#fca5a5">Prestige</h2>
                <p style="font-size:0.9rem">Reset progress to earn <strong style="color:#d8b4fe">Asteroid Shards</strong>.</p>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; margin:10px 0;">
                    Shards to earn: <strong id="rebirth-earn" style="font-size:1.2rem">0</strong>üíé
                </div>
                <button class="btn-buy" style="font-size: 1.2em; padding: 15px; width:100%" onclick="doRebirth()">REBIRTH NOW</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-top:0">Admin Panel</h3>
            <div id="admin-login">
                <input type="password" id="admin-pass" class="admin-input" placeholder="Enter 'Geforce13!'">
                <br><br>
                <button class="btn-buy" onclick="checkAdmin()">Unlock</button>
                <button class="btn-buy" style="background:#475569" onclick="closeModal('admin-modal')">Close</button>
            </div>
            <div id="admin-controls" style="display:none; text-align:left;">
                <label>Run Event:</label>
                <div class="admin-row">
                    <select id="admin-event-select" class="admin-input">
                        <option value="none">-- Select Event --</option>
                        <option value="candy-sage">Candy Sage (3x, 5min)</option>
                        <option value="grassland-joy">Grassland Joy (6x, 5min)</option>
                    </select>
                    <button class="btn-buy" onclick="adminRunEvent()">Run</button>
                </div>
                <div class="admin-row">
                    <button class="btn-buy" onclick="adminGen('clicks')">+Clicks</button>
                    <button class="btn-buy" onclick="adminGen('shards')">+Shards</button>
                    <input type="number" id="admin-gen-val" class="admin-input" value="1000">
                </div>
                <button class="btn-buy" style="background:#475569; width:100%; margin-top:10px" onclick="closeModal('admin-modal')">Close Panel</button>
            </div>
        </div>
    </div>

    <div id="notification-area"></div>

    <script>
        /* --- GAME DATA --- */
        const defaultState = {
            clicks: 0, shards: 0, rebirths: 0, clickCost: 50, clickMultiplier: 1, autoClickers: [0, 0, 0],
            themesUnlocked: ['theme-default'], currentTheme: 'theme-default',
            shardUpgrades: { extraShard: 0, startBonus: false }, settings: { sfx: true, music: false },
            event: { active: false, name: null, multiplier: 1, duration: 0, endTime: 0, particles: null, originalTheme: 'theme-default' },
            cooldowns: { frenzy: 0, frenzyMax: 300, frenzyDuration: 30 }, 
            eventTimer: 0,
            leaderboard: {
                clicks: [], shards: [], rebirths: []
            }
        };

        let game = JSON.parse(JSON.stringify(defaultState));
        const autoRates = [1, 10, 50]; 

        const themes = [
            { id: 'theme-default', name: 'Cosmic', cost: 0, type: 'gradient', color: 'linear-gradient(135deg, #000, #434343)' },
            { id: 'theme-mars', name: 'Mars', cost: 1, type: 'plain', color: '#7f1d1d' },
            { id: 'theme-neptune', name: 'Neptune', cost: 1, type: 'plain', color: '#1e3a8a' },
            { id: 'theme-gold', name: 'Gold Rush', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #BF953F, #FCF6BA)' },
            { id: 'theme-nebula', name: 'Nebula', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #4c1d95, #db2777)' },
            { id: 'theme-matrix', name: 'Matrix', cost: 5, type: 'special', color: '#000' },
            { id: 'theme-lava', name: 'Lava', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #f43f5e, #f97316)' },
            { id: 'theme-aqua', name: 'Aqua', cost: 1, type: 'plain', color: '#06b6d4' },
            { id: 'theme-void', name: 'Void', cost: 1, type: 'plain', color: '#000000' },
            { id: 'theme-sunset', name: 'Sunset', cost: 2, type: 'gradient', color: 'linear-gradient(135deg, #fef08a, #f97316)' },
            { id: 'theme-silver', name: 'Silver', cost: 1, type: 'plain', color: '#6b7280' }
        ];

        /* --- AUDIO ENGINE --- */
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let musicTimer = null;
        let noteIndex = 0;
        let currentMusicType = 'none';

        function playTone(freq, type, duration, vol = 0.1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playHiHat() {
            const bufferSize = audioCtx.sampleRate * 0.05; 
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 5000;
            const gain = audioCtx.createGain();
            gain.gain.value = 0.05;
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start();
        }

        function musicLoop() {
            if (!game.settings.music) return;
            if (document.getElementById('main-menu-overlay').style.display !== 'none') return;

            if (currentMusicType === 'action') {
                const beat = noteIndex % 16;
                if (beat === 0) playTone(98.00, 'sawtooth', 0.4, 0.15); 
                if (beat === 3) playTone(98.00, 'sawtooth', 0.4, 0.15); 
                if (beat === 6) playTone(116.54, 'square', 0.2, 0.1);  
                if (beat === 8) playTone(130.81, 'square', 0.2, 0.1);  
                if (beat % 2 === 0) playHiHat();
            } 
            else if (currentMusicType === 'chill') {
                const beat = noteIndex % 32;
                if (beat === 0) playTone(196.00, 'triangle', 2, 0.05); 
                if (beat === 8) playTone(246.94, 'triangle', 2, 0.05); 
                if (beat === 16) playTone(293.66, 'triangle', 2, 0.05); 
                if (beat === 24) playTone(392.00, 'triangle', 2, 0.05); 
            }
            noteIndex++;
        }

        function updateMusicState() {
            if (!game.settings.music) {
                if (musicTimer) clearInterval(musicTimer);
                musicTimer = null;
                currentMusicType = 'none';
                return;
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const targetType = game.event.active ? 'action' : 'chill';
            const interval = targetType === 'action' ? 150 : 250; 

            if (currentMusicType !== targetType) {
                if (musicTimer) clearInterval(musicTimer);
                noteIndex = 0;
                currentMusicType = targetType;
                musicTimer = setInterval(musicLoop, interval);
            }
        }

        function playClickSound() { if (game.settings.sfx) playTone(400 + Math.random() * 200, 'sine', 0.1, 0.1); }
        function playSkillSound() { if (game.settings.sfx) { playTone(600, 'square', 0.3, 0.1); setTimeout(() => playTone(800, 'square', 0.3, 0.1), 100); } }

        /* --- UI UTILITIES --- */
        function formatNum(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return Math.floor(num);
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function notify(msg) {
            const area = document.getElementById('notification-area');
            const d = document.createElement('div');
            d.className = 'notif';
            d.innerText = msg;
            area.appendChild(d);
            setTimeout(() => d.remove(), 2500);
        }

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-'+id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${id}')"]`).classList.add('active');
            
            if(id === 'feats') renderLeaderboard();
        }

        /* --- MENU LOGIC --- */
        function startGame() {
            document.getElementById('main-menu-overlay').style.display = 'none';
            if (audioCtx.state === 'suspended') audioCtx.resume();
            updateMusicState();
        }

        function openMainMenu() {
            document.getElementById('main-menu-overlay').style.display = 'flex';
            document.getElementById('menu-shards').innerText = formatNum(game.shards);
            document.getElementById('menu-rebirths').innerText = formatNum(game.rebirths);
        }
        
        /* --- CORE LOGIC --- */
        function calculateClickPower() {
            let base = game.clickMultiplier * (game.rebirths + 1);
            let totalMult = base * game.event.multiplier; 
            if(game.cooldowns.frenzy > 0) totalMult *= 2; 
            return totalMult;
        }

        function calculateCPS() {
            let cps = 0;
            game.autoClickers.forEach((count, i) => cps += count * autoRates[i]);
            if(game.cooldowns.frenzy > 0) cps *= 2; 
            return cps;
        }

        function clickPlanet(e) {
            if(e) e.preventDefault(); 
            if(document.getElementById('main-menu-overlay').style.display === 'flex') return;
            game.clicks += calculateClickPower();
            playClickSound();
            updateDisplay();
            const btn = document.getElementById('clicker-btn');
            btn.style.transform = 'scale(0.92)';
            setTimeout(() => btn.style.transform = 'scale(1)', 50);
        }
        
        document.getElementById('clicker-btn').addEventListener('touchstart', (e) => { e.preventDefault(); clickPlanet(); }, {passive: false});
        document.getElementById('clicker-btn').addEventListener('mousedown', clickPlanet);

        function updateDisplay() {
            document.getElementById('display-clicks').innerText = formatNum(game.clicks);
            document.getElementById('display-shards').innerText = formatNum(game.shards);
            document.getElementById('display-rebirths').innerText = formatNum(game.rebirths);
            document.getElementById('display-cpt').innerText = formatNum(calculateClickPower());
            document.getElementById('display-cps').innerText = formatNum(calculateCPS());
            document.getElementById('rebirth-earn').innerText = formatNum(Math.floor(game.clicks / 2000) + game.shardUpgrades.extraShard);
            document.getElementById('menu-shards').innerText = formatNum(game.shards);
            document.getElementById('menu-rebirths').innerText = formatNum(game.rebirths);
            document.getElementById('cost-click').innerText = formatNum(game.clickCost);
            document.getElementById('cost-auto-0').innerText = formatNum(Math.floor(100 * Math.pow(1.1, game.autoClickers[0])));
            document.getElementById('cost-auto-1').innerText = formatNum(Math.floor(500 * Math.pow(1.1, game.autoClickers[1])));
            document.getElementById('cost-auto-2').innerText = formatNum(Math.floor(2000 * Math.pow(1.1, game.autoClickers[2])));

            const btn = document.getElementById('frenzy-btn');
            if (game.cooldowns.frenzy > 0) {
                btn.innerText = `Frenzy (${game.cooldowns.frenzy}s)`;
                btn.disabled = true;
                btn.style.backgroundColor = 'var(--green)';
            } else if (game.cooldowns.frenzy < 0) {
                btn.innerText = `Cooling (${Math.abs(game.cooldowns.frenzy)}s)`;
                btn.disabled = true;
                btn.style.backgroundColor = 'var(--cooldown-color)';
            } else {
                btn.innerText = 'Frenzy (2x)';
                btn.disabled = false;
                btn.style.backgroundColor = 'var(--primary)';
            }
        }

        /* --- LEADERBOARD LOGIC (NEW) --- */
        function updateLeaderboard(key, score) {
            // Find existing score or set a new one
            let found = false;
            for(let i=0; i<game.leaderboard[key].length; i++) {
                if (game.leaderboard[key][i].id === 'player') {
                    if (score > game.leaderboard[key][i].score) {
                        game.leaderboard[key][i].score = score;
                    }
                    found = true;
                    break;
                }
            }
            if (!found) {
                game.leaderboard[key].push({ id: 'player', score: score });
            }

            // Sort and trim (keep top 5 plus the player's score if it's outside the top 5)
            game.leaderboard[key].sort((a, b) => b.score - a.score);
            
            // Only keep top 5 unique entries (since 'player' can appear only once now)
            game.leaderboard[key] = game.leaderboard[key].slice(0, 5);
        }

        function renderLeaderboard() {
            const keys = ['clicks', 'shards', 'rebirths'];
            keys.forEach(key => {
                const tbody = document.getElementById(`lb-${key}`);
                tbody.innerHTML = '';
                
                // Ensure player's current score is reflected for display
                const playerScore = (key === 'clicks' ? game.clicks : key === 'shards' ? game.shards : game.rebirths);
                updateLeaderboard(key, playerScore);

                game.leaderboard[key].forEach((entry, index) => {
                    const tr = document.createElement('tr');
                    tr.className = entry.id === 'player' ? 'highlight-row' : '';
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${formatNum(entry.score)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }
        
        /* --- MINIGAMES --- */
        
        // --- 1. SLOTS ---
        const slotSymbols = ['üöÄ', 'üëΩ', 'ü™ê', '‚≠êÔ∏è', '‚òÑÔ∏è'];
        let isSpinning = false;

        function playSlots() {
            if (isSpinning) return;
            const cost = 1000;
            if (game.clicks < cost) { notify("Not enough clicks!"); return; }
            
            game.clicks -= cost;
            updateDisplay();
            isSpinning = true;
            document.getElementById('slot-btn').disabled = true;
            document.getElementById('slot-msg').innerText = "Spinning...";

            const r1 = document.getElementById('reel-1');
            const r2 = document.getElementById('reel-2');
            const r3 = document.getElementById('reel-3');
            
            let spins = 0;
            const interval = setInterval(() => {
                r1.innerText = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                r2.innerText = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                r3.innerText = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                playTone(300, 'square', 0.05, 0.05); // Spin sound
                spins++;
                if(spins > 20) {
                    clearInterval(interval);
                    finalizeSlots();
                }
            }, 100);
        }

        function finalizeSlots() {
            const r1 = document.getElementById('reel-1');
            const r2 = document.getElementById('reel-2');
            const r3 = document.getElementById('reel-3');
            
            const v1 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            const v2 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            const v3 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            
            // Staggered stop effect
            setTimeout(() => { r1.innerText = v1; playTone(500, 'sine', 0.1); }, 0);
            setTimeout(() => { r2.innerText = v2; playTone(500, 'sine', 0.1); }, 300);
            setTimeout(() => { 
                r3.innerText = v3; 
                playTone(500, 'sine', 0.1); 
                checkSlotWin(v1, v2, v3);
            }, 600);
        }

        function checkSlotWin(v1, v2, v3) {
            isSpinning = false;
            document.getElementById('slot-btn').disabled = false;
            
            if (v1 === v2 && v2 === v3) {
                const reward = calculateClickPower() * 500;
                game.clicks += reward;
                game.shards += 1;
                document.getElementById('slot-msg').innerText = `JACKPOT! +${formatNum(reward)} Clicks & 1üíé`;
                document.getElementById('slot-msg').style.color = 'var(--green)';
                playSkillSound();
            } else if (v1 === v2 || v2 === v3 || v1 === v3) {
                const reward = calculateClickPower() * 50;
                game.clicks += reward;
                document.getElementById('slot-msg').innerText = `Mini Win! +${formatNum(reward)} Clicks`;
                document.getElementById('slot-msg').style.color = '#fff';
            } else {
                document.getElementById('slot-msg').innerText = "Try again!";
                document.getElementById('slot-msg').style.color = 'var(--grey)';
            }
            updateDisplay();
        }

        // --- 2. MEMORY MATRIX ---
        const memoryIcons = ['üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üíÄ', 'üëª', 'üê≤', 'üëπ'];
        let flippedCards = [];
        let matchedPairs = 0;
        let isMemoryLocked = false;

        function startMemoryGame() {
            const cost = 500;
            if (game.clicks < cost) { notify("Not enough clicks!"); return; }
            if (document.getElementById('memory-btn').innerText === "Playing...") return;

            game.clicks -= cost;
            updateDisplay();
            
            // Setup Board
            const gridEl = document.getElementById('memory-grid');
            gridEl.innerHTML = '';
            flippedCards = [];
            matchedPairs = 0;
            isMemoryLocked = false;
            document.getElementById('memory-btn').innerText = "Playing...";
            document.getElementById('memory-btn').disabled = true;

            // Create pairs
            let deck = [...memoryIcons, ...memoryIcons];
            deck.sort(() => Math.random() - 0.5);

            deck.forEach((icon, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.icon = icon;
                card.dataset.index = index;
                card.innerText = '?';
                card.onclick = () => flipCard(card);
                gridEl.appendChild(card);
            });
        }

        function flipCard(card) {
            if (isMemoryLocked) return;
            if (card.classList.contains('flipped') || card.classList.contains('matched')) return;

            // Flip
            card.classList.add('flipped');
            card.innerText = card.dataset.icon;
            flippedCards.push(card);
            playTone(600, 'sine', 0.1);

            if (flippedCards.length === 2) {
                isMemoryLocked = true;
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [c1, c2] = flippedCards;
            if (c1.dataset.icon === c2.dataset.icon) {
                // Match
                playTone(800, 'square', 0.1);
                c1.classList.add('matched');
                c2.classList.add('matched');
                matchedPairs++;
                flippedCards = [];
                isMemoryLocked = false;
                
                if (matchedPairs === 8) {
                    const reward = calculateClickPower() * 800;
                    notify(`HACK COMPLETE! +${formatNum(reward)} Clicks`);
                    game.clicks += reward;
                    updateDisplay();
                    document.getElementById('memory-btn').innerText = "Start Hack";
                    document.getElementById('memory-btn').disabled = false;
                }
            } else {
                // No Match
                setTimeout(() => {
                    c1.classList.remove('flipped');
                    c1.innerText = '?';
                    c2.classList.remove('flipped');
                    c2.innerText = '?';
                    flippedCards = [];
                    isMemoryLocked = false;
                }, 800);
            }
        }

        // --- 3. SPACE JUMP (NEW) ---
        let jumpGame = {
            running: false,
            playerY: 10,
            velocityY: 0,
            gravity: -1.5,
            jumpStrength: 20,
            score: 0,
            obstacles: [],
            gameInterval: null,
            obstacleSpawnInterval: null
        };
        const playerEl = document.getElementById('jump-player');
        const jumpContainer = document.getElementById('space-jump-container');
        const jumpBtn = document.getElementById('jump-btn');
        const jumpMsg = document.getElementById('jump-msg');
        const jumpScoreEl = document.getElementById('jump-score');

        function startJumpGame() {
            const cost = 1000;
            if (game.clicks < cost) { notify("Not enough clicks!"); return; }
            if (jumpGame.running) return;

            game.clicks -= cost;
            updateDisplay();
            
            jumpGame.running = true;
            jumpGame.score = 0;
            jumpGame.playerY = 10;
            jumpGame.velocityY = 0;
            jumpGame.obstacles = [];
            
            playerEl.style.bottom = jumpGame.playerY + 'px';
            playerEl.style.backgroundColor = 'var(--green)';
            jumpMsg.innerText = '';
            jumpBtn.disabled = true;
            jumpScoreEl.innerText = 'Score: 0';
            
            // Clear old obstacles
            jumpContainer.querySelectorAll('.jump-obstacle').forEach(o => o.remove());

            // Start game loop
            jumpGame.gameInterval = setInterval(updateJumpGame, 30);
            jumpGame.obstacleSpawnInterval = setInterval(spawnObstacle, 1500 + Math.random() * 1000);
            
            notify("Space Jump Started!");
        }

        function jumpGameJump() {
            if (!jumpGame.running) {
                startJumpGame();
                return; 
            }
            if (jumpGame.playerY <= 10) { 
                jumpGame.velocityY = jumpGame.jumpStrength;
                playTone(400, 'square', 0.1, 0.1);
            }
        }
        
        // Handle clicks anywhere in the container
        jumpContainer.onclick = jumpGameJump;

        function updateJumpGame() {
            if (!jumpGame.running) return;

            // Player Physics
            jumpGame.velocityY += jumpGame.gravity;
            jumpGame.playerY += jumpGame.velocityY;

            if (jumpGame.playerY < 10) {
                jumpGame.playerY = 10;
                jumpGame.velocityY = 0;
            }
            playerEl.style.bottom = jumpGame.playerY + 'px';

            // Update Obstacles
            jumpGame.obstacles.forEach(o => {
                o.x -= 5; // Movement speed
                o.el.style.left = o.x + 'px';
                
                // Collision Check (AABB simplified)
                const playerRect = playerEl.getBoundingClientRect();
                const obsRect = o.el.getBoundingClientRect();
                
                const collision = 
                    playerRect.right > obsRect.left && 
                    playerRect.left < obsRect.right &&
                    playerRect.bottom > obsRect.top;

                if (collision) {
                    endJumpGame(false);
                }

                // Scoring
                if (o.x < 10 && !o.passed) {
                    o.passed = true;
                    jumpGame.score++;
                    jumpScoreEl.innerText = `Score: ${jumpGame.score}`;
                    playTone(800, 'sine', 0.05, 0.05); // Score sound
                }
                
                // Clean up passed obstacles
                if (o.x < -20) o.el.remove();
            });

            // Remove off-screen obstacles from array
            jumpGame.obstacles = jumpGame.obstacles.filter(o => o.x > -20);
        }

        function spawnObstacle() {
            if (!jumpGame.running) return;
            
            const h = 10 + Math.random() * 40; // Height of obstacle
            const o = document.createElement('div');
            o.className = 'jump-obstacle';
            o.style.height = h + 'px';
            o.style.left = jumpContainer.clientWidth + 'px';
            jumpContainer.appendChild(o);
            
            jumpGame.obstacles.push({ el: o, x: jumpContainer.clientWidth, h: h, passed: false });
        }

        function endJumpGame(win = false) {
            if (!jumpGame.running) return;
            
            jumpGame.running = false;
            clearInterval(jumpGame.gameInterval);
            clearInterval(jumpGame.obstacleSpawnInterval);
            jumpBtn.disabled = false;
            playerEl.style.backgroundColor = 'var(--danger)'; // Indicate hit
            
            // Calculate reward (Max 20 score)
            const finalScore = jumpGame.score;
            const multiplier = Math.min(finalScore, 20); // Cap multiplier at 20
            const reward = calculateClickPower() * 100 * multiplier; 
            
            if (finalScore > 0) {
                game.clicks += reward;
                jumpMsg.innerText = `Crashed! Score: ${finalScore}. Earned +${formatNum(reward)} Clicks.`;
                jumpMsg.style.color = 'var(--cooldown-color)';
                playTone(100, 'sawtooth', 0.5); // Crash sound
            } else {
                jumpMsg.innerText = `Crashed! Score: 0. Better luck next time.`;
                jumpMsg.style.color = 'var(--danger)';
                playTone(100, 'sawtooth', 0.5); 
            }
            updateDisplay();
        }


        /* --- SHOP ACTIONS --- */
        function buyClickUpgrade() {
            if (game.clicks >= game.clickCost) {
                game.clicks -= game.clickCost;
                game.clickMultiplier *= 2;
                game.clickCost = Math.floor(game.clickCost * 2);
                updateDisplay();
            }
        }
        function buyAuto(index) {
            const cost = Math.floor((index === 0 ? 100 : index === 1 ? 500 : 2000) * Math.pow(1.1, game.autoClickers[index]));
            if (game.clicks >= cost) {
                game.clicks -= cost;
                game.autoClickers[index]++;
                updateDisplay();
            }
        }
        function buyShardUpgrade(type) {
            const cost = (type === 'extraShard') ? 5 : 10;
            if (game.shards >= cost) {
                game.shards -= cost;
                if (type === 'extraShard') game.shardUpgrades.extraShard++;
                else if (type === 'startBonus') game.shardUpgrades.startBonus = true;
                updateDisplay();
                document.getElementById('extraShardCount').innerText = game.shardUpgrades.extraShard;
                document.getElementById('startBonusStatus').innerText = game.shardUpgrades.startBonus ? 'Unlocked' : 'Not Unlocked';
            }
        }
        function doRebirth() {
            let gain = Math.floor(game.clicks / 2000);
            if(gain > 0) gain += game.shardUpgrades.extraShard;
            
            if (gain > 0) {
                game.shards += gain;
                game.rebirths++;
                // Update leaderboard before reset
                updateLeaderboard('shards', game.shards);
                updateLeaderboard('rebirths', game.rebirths);

                const keep = { shards: game.shards, rebirths: game.rebirths, themesUnlocked: game.themesUnlocked, currentTheme: game.currentTheme, shardUpgrades: game.shardUpgrades, settings: game.settings, leaderboard: game.leaderboard };
                game = { ...defaultState, ...keep };
                if (game.shardUpgrades.startBonus) game.clicks = 500;
                endEvent();
                updateDisplay();
                notify("Rebirth Complete! You feel stronger.");
            }
        }

        /* --- EVENT SYSTEM --- */
        const eventData = {
            'candy-sage': { name: 'Candy Sage', mult: 3, duration: 300, theme: 'event-candy-sage', particles: { count: 30, color: '#fbcfe8', shape: 'üç¨', size: 10 } },
            'grassland-joy': { name: 'Grassland Joy', mult: 6, duration: 300, theme: 'event-grassland-joy', particles: { count: 50, color: '#4ade80', shape: 'üåø', size: 8 } }
        };

        function startEvent(key) {
            if (game.event.active) return;
            const data = eventData[key];
            game.event.active = true;
            game.event.name = data.name;
            game.event.multiplier = data.mult;
            game.event.duration = data.duration;
            game.event.endTime = Date.now() + (data.duration * 1000);
            game.event.originalTheme = document.body.className;

            document.body.className = data.theme;
            
            const hud = document.getElementById('event-hud');
            document.getElementById('hud-name').innerText = data.name;
            document.getElementById('hud-mult').innerText = data.mult + 'X';
            hud.classList.add('active');

            startParticles(data.particles);
            updateMusicState(); 
            notify(data.name + " Event Started!");
        }

        function endEvent() {
            if (!game.event.active) return;
            document.body.className = game.event.originalTheme || 'theme-default'; 
            game.event.active = false;
            game.event.multiplier = 1;
            document.getElementById('event-hud').classList.remove('active');
            stopParticles();
            updateMusicState();
            notify("Event Ended.");
            game.eventTimer = 0; 
        }

        function startParticles(opts) {
            stopParticles();
            const overlay = document.getElementById('particle-overlay');
            const styleSheet = document.styleSheets[0];
            const kfName = `fall-${opts.shape.charCodeAt(0)}`;
            let ruleExists = Array.from(styleSheet.cssRules).some(r => r.name === kfName);
            if (!ruleExists) {
                styleSheet.insertRule(`@keyframes ${kfName} { 0% { transform: translateY(-100px) rotate(0deg); } 100% { transform: translateY(100vh) rotate(360deg); } }`, styleSheet.cssRules.length);
            }
            for(let i=0; i<opts.count; i++) {
                const p = document.createElement('div');
                p.innerText = opts.shape;
                p.style.position = 'absolute';
                p.style.color = opts.color;
                p.style.fontSize = opts.size + 'px';
                p.style.left = Math.random()*100 + 'vw';
                p.style.top = Math.random()*-100 + 'px';
                p.style.animation = `${kfName} ${5+Math.random()*5}s linear infinite`;
                overlay.appendChild(p);
            }
        }
        function stopParticles() { document.getElementById('particle-overlay').innerHTML = ''; }

        /* --- THEMES & EXTRAS --- */
        function renderThemes() {
            const grid = document.getElementById('theme-grid');
            grid.innerHTML = '';
            themes.forEach(t => {
                const unlocked = game.themesUnlocked.includes(t.id);
                const d = document.createElement('div');
                d.className = `theme-item ${unlocked?'':'locked'} ${game.currentTheme===t.id?'active-theme':''}`;
                d.style.background = t.color;
                d.innerText = t.name + (unlocked ? '' : `\n(${t.cost}üíé)`);
                d.onclick = () => {
                    if(unlocked) { document.body.className = t.id; game.currentTheme = t.id; renderThemes(); }
                    else if(game.shards >= t.cost) { game.shards -= t.cost; game.themesUnlocked.push(t.id); renderThemes(); updateDisplay(); }
                };
                grid.appendChild(d);
            });
        }
        function toggleSetting(s) { 
            game.settings[s] = document.getElementById(`toggle-${s}`).checked; 
            if(s==='music') updateMusicState();
        }
        function activateFrenzy() {
            if(game.cooldowns.frenzy === 0) { game.cooldowns.frenzy = 30; playSkillSound(); }
        }
        function spawnGoldenPlanet() {
            const p = document.createElement('div');
            p.className = 'golden-planet';
            p.style.left = Math.random() * (window.innerWidth - 60) + 'px';
            p.style.top = Math.random() * (window.innerHeight - 200) + 100 + 'px';
            p.onclick = () => {
                game.clicks += calculateClickPower() * 1000;
                game.shards += 0.1;
                playSkillSound();
                p.remove();
                notify("Golden Planet Found!");
            };
            document.getElementById('game-area').appendChild(p);
            setTimeout(() => { if(p.parentNode) p.remove(); }, 15000);
        }

        /* --- GAME LOOPS --- */
        setInterval(() => {
            game.clicks += calculateCPS();
            
            // Update leaderboard (Clicks/Shards/Rebirths)
            updateLeaderboard('clicks', game.clicks);
            updateLeaderboard('shards', game.shards);
            updateLeaderboard('rebirths', game.rebirths);
            
            if(game.event.active) {
                const remaining = Math.max(0, (game.event.endTime - Date.now()) / 1000);
                document.getElementById('hud-time').innerText = formatTime(remaining);
                if(remaining <= 0) endEvent();
            } else {
                game.eventTimer++;
                if(game.eventTimer >= 600) startEvent(Object.keys(eventData)[Math.floor(Math.random()*2)]);
            }

            if(game.cooldowns.frenzy > 0) {
                game.cooldowns.frenzy--;
                if(game.cooldowns.frenzy === 0) game.cooldowns.frenzy = -300;
            } else if (game.cooldowns.frenzy < 0) {
                game.cooldowns.frenzy++;
            }

            if(Math.random() < 0.01 && !document.querySelector('.golden-planet')) spawnGoldenPlanet();
            updateDisplay();
        }, 1000);

        /* --- ADMIN --- */
        function openAdminModal() { document.getElementById('admin-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function checkAdmin() {
            if(document.getElementById('admin-pass').value === 'Geforce13!') {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-controls').style.display = 'block';
            }
        }
        function adminRunEvent() { startEvent(document.getElementById('admin-event-select').value); closeModal('admin-modal'); }
        function adminGen(t) { 
            const val = parseInt(document.getElementById('admin-gen-val').value);
            if(t==='clicks') game.clicks += val;
            if(t==='shards') game.shards += val;
            updateDisplay();
        }
        
        function hardReset() {
            if (confirm("Are you sure? This will wipe everything!")) {
                localStorage.removeItem('cosmicClickerSave');
                game = JSON.parse(JSON.stringify(defaultState));
                endEvent();
                updateDisplay();
                renderThemes();
                openMainMenu();
            }
        }

        /* --- SAVE/LOAD --- */
        function saveGame() { localStorage.setItem('cosmicClickerSave', JSON.stringify(game)); }
        function loadGame() {
            const s = localStorage.getItem('cosmicClickerSave');
            if(s) {
                const p = JSON.parse(s);
                game = { ...defaultState, ...p };
                // Deep merge necessary objects that may be missing in old saves
                game.event = { ...defaultState.event, ...(p.event||{}) };
                game.leaderboard = { ...defaultState.leaderboard, ...(p.leaderboard||{}) };

                if(game.event.active) {
                    const rem = game.event.endTime - Date.now();
                    if(rem > 0) {
                        const d = eventData[game.event.name.toLowerCase().replace(/\s/g, '-')];
                        document.body.className = d.theme;
                        document.getElementById('event-hud').classList.add('active');
                        document.getElementById('hud-name').innerText = d.name;
                        document.getElementById('hud-mult').innerText = d.mult + 'X';
                        startParticles(d.particles);
                    } else endEvent();
                }
            }
            document.body.className = game.currentTheme;
            document.getElementById('toggle-sfx').checked = game.settings.sfx;
            document.getElementById('toggle-music').checked = game.settings.music;
            
            document.getElementById('extraShardCount').innerText = game.shardUpgrades.extraShard;
            document.getElementById('startBonusStatus').innerText = game.shardUpgrades.startBonus ? 'Unlocked' : 'Not Unlocked';

            renderThemes();
            updateDisplay();
            updateMusicState();
            
            openMainMenu();
        }

        window.onload = loadGame;
        setInterval(saveGame, 30000);
    </script>
</body>
</html>
